language: cpp
compiler:
  - gcc
  - clang

# This is a lie: we don't need sudo but this is required to get an
# Ubuntu image with a libc that isn't ancient, and with cmocka libs.
sudo: required
dist: trusty

env:
  global:
  - secure: "isEwSgRODxm9JPZAhQUXP0yqPZmrD0PncBmi/y02RT0oq6Aewdag5f7CzrsJoPsaEsFcJJapIzdZLw1KXHkeAIHNhOtSE4y9tZGFBfB35pFIb0a/Im47djYrVlBXs7Ii/PllzW4xRMmhU16phwsU2N1nFyvfo9qma8R4ComL7GXTn4UqTjADg73YfPKr2NMt/6nilLKNLGE8FhjmPKhnlrBmKgCUU9BAyJ8cOR529bLOp4Wo5pGhopCHUKrYqRErISiFNcCRxjVyUEPUjMVT7/1QPGyAS2bpJa0rc2QYH9w+H0GkzliuGjzEUPaWcpDKjTimEym7F1XfmZxe1RPMH70KGsdlqe4UyWnWzsHDKnU/oCngKecx0g1beFSn/Mwfv58uDHZlegUZrstHDdkP4RZJEWyGkYDzuBCJ2UGAKJGnig/CE4w9fXFhCIltOW7/55KB53wwTec7bCXpoWV2LtC9L8TtdmmdwsBa4NHpZuLxAr3zlKt8O72mlVuo8C6iqwXCL32sahf4KGWNgc/X5GirbvsWvokGchB1p3vgwQdb/NZXKM77r7gMbnGhIOGzEmrCB3olaG+3RtF2+5KID/Z1LZHIlXDtrCa8dAmMvBIFvjFe9/L9T75d8GwiaOg2wEfNTb8bAsPsBdyKiYvWpKMIXJEcCTGKOpC9Nr0/+uk="
  # run coverity scan on gcc build to keep from DOSing coverity
  - coverity_scan_run_condition='"$CC" = gcc'
  - PKG_CONFIG_PATH="$(pwd)/cmocka/lib/pkgconfig:/usr/lib/pkgconfig"
  - LD_LIBRARY_PATH="$(pwd)/cmocka/lib:/usr/lib"
  - CMOCKA_CFLAGS="-I$(pwd)/cmocka/include -I/usr/include"
  - CMOCKA_LIBS="-L$(pwd)/cmocka/lib -lcmocka"

addons:
  apt:
    packages:
    - autoconf-archive
    - cmake
  coverity_scan:
    project:
      name: "01org/TPM2.0-TSS"
      description: Build submitted via Travis-CI
    notification_email: philip.b.tricca@intel.com
    build_command_prepend: "make clean"
    build_command: "make --jobs=$(($(nproc)*2))"
    branch_pattern: coverity_scan

install:
  - echo 'Building TPM2 Simulator...' && echo -en 'travis_fold:start:simulator\\r'
  - wget https://downloads.sourceforge.net/project/ibmswtpm2/ibmtpm532.tar
  - sha256sum ibmtpm532.tar | grep -q ^abc0b420257917ccb42a9750588565d5e84a2b4e99a6f9f46c3dad1f9912864f
  - mkdir ibmtpm532
  - tar axf ibmtpm532.tar -C ibmtpm532
  - make -C ibmtpm532/src -j$(nproc)
  - echo -en 'travis_fold:end:simulator\\r'
  - echo 'Building cmocka...' && echo -en 'travis_fold:start:cmocka\\r'
  - wget https://cmocka.org/files/1.0/cmocka-1.0.1.tar.xz
  - tar -Jxvf cmocka-1.0.1.tar.xz
  - mkdir cmocka
  - cd cmocka-1.0.1
  - mkdir build
  - cd build
  - cmake ../ -DCMAKE_INSTALL_PREFIX=../../cmocka -DCMAKE_BUILD_TYPE=Release
  - make
  - make install
  - cd ../../
  - echo -en 'travis_fold:end:cmocka\\r'

before_script:
  - ./bootstrap

script:
  - echo 'Configuring TSS Source Code...' && echo -en 'travis_fold:start:tss-configure\\r'
  - mkdir ./build
  - pushd ./build
  - ../configure --enable-unit --with-simulatorbin=$(pwd)/../ibmtpm532/src/tpm_server
  - echo -en 'travis_fold:end:tss-configure\\r'
  - echo 'Building TSS Libraries...' && echo -en 'travis_fold:start:tss-build\\r'
  - make -j$(nproc)
  - echo -en 'travis_fold:end:tss-build\\r'
  - echo 'Executing TSS Test Harness...' && echo -en 'travis_fold:start:tss-check\\r'
  - make -j$(nproc) check
  - echo -en 'travis_fold:end:tss-check\\r'
  - echo 'Dumping TSS Unit Test Logs...' && echo -en 'travis_fold:start:tss-unit\\r'
  - |
    for LOG in $(ls -1 test/unit/*.log); do
        echo "${LOG}"
        cat ${LOG}
    done
  - echo -en 'travis_fold:end:tss-unit\\r'
  - echo 'Dumping TSS Integration Test Logs...' && echo -en 'travis_fold:start:tss-integration\\r'
  - |
    for LOG in $(ls -1 test/integration/*.log); do
        echo "${LOG}"
        cat ${LOG}
    done
  - echo -en 'travis_fold:end:tss-integration\\r'
  - echo 'Dumping tpmclient Log...' && echo -en 'travis_fold:start:tss-tpmclient\\r'
  - cat test/tpmclient/tpmclient.log
  - echo -en 'travis_fold:end:tss-tpmclient\\r'
